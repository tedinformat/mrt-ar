<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>捷運窗景互動</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: black; font-family: "Microsoft JhengHei", sans-serif; }

        /* 1. 全螢幕相機容器 */
        #camera-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
        }
        #camera-feed {
            width: 100%; height: 100%; object-fit: cover;
        }

        /* 2. Barcode 圖層 (您的設計圖) */
        #overlay-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2; pointer-events: none; /* 讓點擊穿透 */
            display: flex; justify-content: center; align-items: center;
        }
        #barcode-img {
            width: 85%; max-width: 600px; height: auto; opacity: 0.95;
            /* 稍微加一點陰影讓白色條碼在亮背景也能看清 */
            filter: drop-shadow(0 0 5px rgba(0,0,0,0.3));
        }

        /* 3. 引導文字層 (這次新增的) */
        #instruction-ui {
            position: fixed; top: 15%; width: 100%; z-index: 4;
            display: flex; justify-content: center; pointer-events: none;
            transition: opacity 0.3s;
        }
        .guide-box {
            background-color: rgba(0, 0, 0, 0.6);
            color: white; padding: 12px 24px; border-radius: 30px;
            font-size: 16px; letter-spacing: 1px; text-align: center;
            backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.3);
        }

        /* 4. UI 按鈕層 */
        #ui-layer {
            position: fixed; bottom: 50px; left: 0; width: 100%;
            z-index: 5; display: flex; justify-content: center;
            transition: opacity 0.3s;
        }
        .shutter-btn {
            width: 70px; height: 70px;
            background-color: rgba(255, 255, 255, 0.9);
            border: 4px solid rgba(200, 200, 200, 0.8);
            border-radius: 50%; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }
        .shutter-btn:active { transform: scale(0.95); background-color: white; }

        /* 錯誤訊息 */
        #error-msg {
            display: none; position: fixed; top: 50%; width: 100%; text-align: center;
            color: white; z-index: 99; padding: 20px;
        }
    </style>
</head>
<body>

    <div id="error-msg"></div>

    <div id="camera-container">
        <video id="camera-feed" autoplay playsinline muted></video>
    </div>

    <div id="overlay-layer">
        <img id="barcode-img" src="./barcode.png" alt="Barcode Overlay">
    </div>

    <div id="instruction-ui">
        <div class="guide-box">
            請將圖案對準窗框<br>並按下快門拍照
        </div>
    </div>

    <div id="ui-layer">
        <div class="shutter-btn" id="shutterBtn"></div>
    </div>

    <script>
        const video = document.getElementById('camera-feed');
        const shutterBtn = document.getElementById('shutterBtn');
        const barcodeImg = document.getElementById('barcode-img');
        const instructionUI = document.getElementById('instruction-ui');
        const uiLayer = document.getElementById('ui-layer'); // 按鈕層
        const errorMsg = document.getElementById('error-msg');

        // --- 1. 啟動相機 ---
        async function startCamera() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showError("瀏覽器不支援相機，請使用 Safari 或 Chrome (需 HTTPS)");
                return;
            }
            try {
                // 優先使用後鏡頭 (environment)
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } },
                    audio: false 
                });
                video.srcObject = stream;
            } catch (err) {
                console.warn("後鏡頭啟動失敗，嘗試一般鏡頭...");
                try {
                    const stream2 = await navigator.mediaDevices.getUserMedia({ video: true });
                    video.srcObject = stream2;
                } catch (err2) {
                    showError("無法啟動相機，請檢查權限");
                }
            }
        }
        function showError(msg) {
            errorMsg.innerText = msg; errorMsg.style.display = 'block';
        }
        window.addEventListener('load', startCamera);

        // --- 2. 拍照與合成邏輯 ---
        shutterBtn.addEventListener('click', () => {
            
            // ★ 步驟 A：隱藏 UI (引導文字 + 按鈕)
            instructionUI.style.opacity = '0';
            uiLayer.style.opacity = '0';

            // 給瀏覽器一點時間重繪畫面 (100ms)
            setTimeout(() => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                // 設定高解析度畫布
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                // ★ 步驟 B：繪製背景 (模擬 object-fit: cover 的裁切效果)
                // 這是為了確保拍出來的照片跟螢幕上看到的一樣，不會變形
                const videoRatio = video.videoWidth / video.videoHeight;
                const screenRatio = window.innerWidth / window.innerHeight;
                
                let drawW, drawH, startX, startY;

                if (screenRatio > videoRatio) {
                    // 螢幕比較寬：以寬度為準，裁切上下
                    drawW = canvas.width;
                    drawH = canvas.width / screenRatio;
                    startX = 0;
                    startY = (canvas.height - drawH) / 2;
                } else {
                    // 螢幕比較長(手機通常是這樣)：以高度為準，裁切左右
                    drawH = canvas.height;
                    drawW = canvas.height * screenRatio;
                    startY = 0;
                    startX = (canvas.width - drawW) / 2;
                }
                
                // 繪製影片 (擷取中間部分)
                // 參數：來源X, 來源Y, 來源寬, 來源高, 目標X, 目標Y, 目標寬, 目標高
                // 這裡我們簡單處理：直接畫滿，視覺上最穩定
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                // ★ 步驟 C：繪製 Barcode
                // 計算圖片在畫布上的相對位置
                // 由於我們是全螢幕顯示，我們計算圖片佔螢幕的比例
                const imgRenderWidth = barcodeImg.clientWidth;
                const screenWidth = window.innerWidth;
                const scaleFactor = canvas.width / screenWidth; // 畫布與螢幕的倍率

                // 計算在畫布上要畫多大
                const finalImgW = imgRenderWidth * scaleFactor;
                const finalImgH = (barcodeImg.clientHeight) * scaleFactor;
                
                // 永遠置中
                const finalX = (canvas.width - finalImgW) / 2;
                const finalY = (canvas.height - finalImgH) / 2;

                ctx.drawImage(barcodeImg, finalX, finalY, finalImgW, finalImgH);

                // ★ 步驟 D：下載圖片
                const link = document.createElement('a');
                // 使用當下時間當檔名
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                link.download = `mrt-ar-${timestamp}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.95);
                link.click();

                // ★ 步驟 E：恢復 UI 顯示
                // 延遲一點點再顯示，感覺比較順暢
                setTimeout(() => {
                    instructionUI.style.opacity = '1';
                    uiLayer.style.opacity = '1';
                    
                    // (選用) 拍完後可以改變提示文字，例如：
                    // document.querySelector('.guide-box').innerHTML = "照片已儲存！";
                }, 500);

            }, 100);
        });
    </script>
</body>
</html>
